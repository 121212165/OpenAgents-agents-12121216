# å°æ¸¸æ¢ - ç®€åŒ–ç‰ˆDockeré•œåƒ (é€‚ç”¨äºZeabur)
FROM python:3.11-slim

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV PYTHONPATH=/app
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    curl \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# å¤åˆ¶å¹¶å®‰è£…Pythonä¾èµ–
COPY requirements.txt .
RUN pip install --no-cache-dir --upgrade pip \
    && pip install --no-cache-dir psutil>=5.9.0 \
    && pip install --no-cache-dir -r requirements.txt || echo "Some packages may have failed, continuing..."

# å¤åˆ¶é¡¹ç›®æ–‡ä»¶
COPY src/ ./src/
COPY config/ ./config/

# åˆ›å»ºå¿…è¦ç›®å½•
RUN mkdir -p logs

# åˆ›å»ºç®€åŒ–çš„å¯åŠ¨è„šæœ¬
RUN echo '#!/usr/bin/env python3\n\
import sys\n\
import os\n\
from pathlib import Path\n\
\n\
# è®¾ç½®è·¯å¾„\n\
ROOT_DIR = Path(__file__).parent\n\
sys.path.insert(0, str(ROOT_DIR))\n\
os.environ.setdefault("PYTHONPATH", str(ROOT_DIR))\n\
\n\
# Zeaburç«¯å£å¤„ç†ï¼šå¦‚æœZeaburè®¾ç½®äº†PORTï¼Œä½¿ç”¨å®ƒï¼›å¦åˆ™ä½¿ç”¨8000\n\
if os.getenv("PORT"):\n\
    os.environ["OPENAGENTS_PORT"] = os.getenv("PORT")\n\
    print(f"[Zeabur] ä½¿ç”¨ç«¯å£: {os.getenv(\"PORT\")}")\n\
else:\n\
    os.environ.setdefault("OPENAGENTS_PORT", "8000")\n\
    print(f"[é»˜è®¤] ä½¿ç”¨ç«¯å£: 8000")\n\
\n\
os.environ.setdefault("OPENAGENTS_HOST", "0.0.0.0")\n\
\n\
if __name__ == "__main__":\n\
    try:\n\
        from src.main import main\n\
        import asyncio\n\
        \n\
        # æ·»åŠ openagentså‚æ•°\n\
        if "--openagents" not in sys.argv:\n\
            sys.argv.append("--openagents")\n\
        \n\
        print("ğŸš€ å¯åŠ¨å°æ¸¸æ¢...")\n\
        asyncio.run(main())\n\
    except Exception as e:\n\
        print(f"âŒ å¯åŠ¨å¤±è´¥: {e}")\n\
        import traceback\n\
        traceback.print_exc()\n\
        sys.exit(1)\n\
' > /app/run.py && chmod +x /app/run.py

# æš´éœ²ç«¯å£
EXPOSE 8000

# ç®€åŒ–çš„å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=60s --timeout=30s --start-period=60s --retries=3 \
    CMD python -c "import urllib.request; urllib.request.urlopen('http://localhost:8000/health', timeout=10)" || exit 1

# å¯åŠ¨å‘½ä»¤
CMD ["python", "run.py"]